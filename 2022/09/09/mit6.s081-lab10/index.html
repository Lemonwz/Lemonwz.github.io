<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>mit6.s081 lab10 - mmap | Comethru</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Comethru">
    <meta name="author" content="DaiWei Jia">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="Comethru" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="/" target="_BLANK" class="animsition-link">AAA</a></li>
                    
                        <li><a href="/atom.xml" target="_BLANK" class="animsition-link">BBB</a></li>
                    
                </ul>
            </li>
            
            
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a target="_blank" rel="noopener" href="http://go.kieran.top/" class="animsition-link">Kieran</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="http://domain.com/" class="animsition-link">Name</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">Comethru</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a></li>
                            
                            
                            <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a></li>
                            
                            
                            <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2022-09-09T07:51:27.921Z" itemprop="datePublished">
          2022-09-09
      </time>
    
</span>
                <h1>mit6.s081 lab10 - mmap</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<h1 id="lab-mmap"><a href="#lab-mmap" class="headerlink" title="lab mmap"></a>lab mmap</h1><p>这部分实验要求实现mmap和munmap系统调用，将完整或部分文件映射到内存空间中，从而通过内存地址相关指令来操纵文件，相较于read/write系统调用省去了在用户空间和内核空间来回切换的开销；并支持在移除映射时将脏数据写回磁盘</p>
<p>mmap函数定义如下，表示从文件描述符fd的addr+offset位置开始映射length字节到虚拟地址addr，并设置相应的访问权限和写回策略</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset)</span></span>;</span><br></pre></td></tr></table></figure>

<p>addr：映射文件的虚拟地址，实验中默认为0，即由内核选择合适的虚拟地址，mmap函数返回该地址</p>
<p>length：映射到内存中的文件字节数</p>
<p>prot：指定内存的访问权限，这里包括可读、可写或可读写</p>
<p>flags：指定脏页面是否写回，MAP_SHARED表示需要写回，MAP_PRIVATE表示不需要写回</p>
<p>fd：映射文件的文件描述符</p>
<p>offset：偏移量，即文件映射的开始位置，实验中默认为0</p>
<p>munmap函数定义如下，移除从虚拟地址addr开始length字节地址范围内的mmap映射</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">munmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length)</span></span></span><br></pre></td></tr></table></figure>

<p>mmap的总体流程如下：</p>
<ol>
<li>通过open系统调用打开文件并返回对应的文件描述符，调用mmap函数，<strong>由用户态转为内核态</strong></li>
<li>在当前进程的虚拟地址空间中找到一段空闲的连续的虚拟地址，分配一个vma结构体记录虚拟地址区域和对应的文件对象，将这个vma结构体插入到进程的虚拟地址区域链表中（实验中是vma结构体数组），返回文件映射的虚拟地址，<strong>由内核态转为用户态</strong></li>
<li>由于并没有真正创建映射以及拷贝文件内容到主存，因此对文件的读写操作访问虚拟地址时会引发缺页异常并被异常处理程序捕获，<strong>由用户态转为内核态</strong></li>
<li>检测到触发缺页异常的虚拟地址在进程的文件映射虚拟地址区域内，查找得到对应的vma结构体</li>
<li><strong>拷贝文件内容到主存</strong>，并建立触发缺页异常的虚拟地址和物理地址的映射，<strong>由内核态转为用户态</strong></li>
<li>之后进程便可以对文件进行读写操作，如果修改了文件内容，在unmmap时会将脏页面写回到磁盘地址</li>
</ol>
<p><strong>具体实现：</strong></p>
<p>mmap系统调用不会立即将文件内容从磁盘拷贝到内存中，通常是采用lazy的方式，在访问虚拟地址出现page fault时才分配页面并创建映射，因此我们需要记录文件映射的相关信息，这里定义了vma结构体，并为每个进程维护一个vma结构体数组</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vma</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> valid;</span><br><span class="line">  <span class="keyword">int</span> prot;</span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line">  uint64 sva;</span><br><span class="line">  uint64 len;</span><br><span class="line">  uint64 offset;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> <span class="title">vmas</span>[<span class="title">VMASIZE</span>];</span>    <span class="comment">// Virtual memory area</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>mmap系统调用实现流程如下：</p>
<ol>
<li>接收来自用户程序的参数</li>
<li>检查指定的读写权限和文件实际读写权限是否冲突，如将不可写文件映射到可写的内存或将不可读的文件映射到可读内存</li>
<li>在进程虚拟地址空间中找到合适的区域用来映射文件，这里选取trapframe下面的部分，自上而下顺序分配（遍历进程的vma结构体数组，检查valid字段判断当前虚拟地址区域是否已分配，如果已分配，则更新end值为当前区域的起始虚拟地址）</li>
<li>如果找到了空闲虚拟地址区域，则根据传入的参数设置对应vma结构体的值（起始地址为end-length）</li>
<li>增加对应文件的引用数，返回映射文件的起始地址</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_mmap</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> prot, flags, fd, len, offset;</span><br><span class="line">  uint64 va, end = TRAPFRAME;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(argaddr(<span class="number">0</span>, &amp;va) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">1</span>, &amp;len) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">2</span>, &amp;prot) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">3</span>, &amp;flags) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span>(argfd(<span class="number">4</span>, &amp;fd, &amp;f) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">5</span>, &amp;offset) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// map unwritable file to writeable and write back modification</span></span><br><span class="line">  <span class="keyword">if</span>(!f-&gt;writable &amp;&amp; (prot &amp; PROT_WRITE) &amp;&amp; (flags &amp; MAP_SHARED))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">// map unreadable file to readable</span></span><br><span class="line">  <span class="keyword">if</span>(!f-&gt;readable &amp;&amp; (prot &amp; PROT_READ))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">// find an unused region in the process&#x27;s address space</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">v</span> =</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;VMASIZE; i++)&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">vv</span> =</span> &amp;p-&gt;vmas[i];</span><br><span class="line">    <span class="keyword">if</span>(!vv-&gt;valid)&#123;</span><br><span class="line">      v = vv;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    end = PGROUNDDOWN(vv-&gt;sva);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(v == <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;mmap: out of vmas&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add a VMA to the process&#x27;s table of mapped regions</span></span><br><span class="line">  v-&gt;valid = <span class="number">1</span>;</span><br><span class="line">  v-&gt;sva = end - len;</span><br><span class="line">  v-&gt;len = len;</span><br><span class="line">  v-&gt;offset = offset;</span><br><span class="line">  v-&gt;prot = prot;</span><br><span class="line">  v-&gt;flags = flags;</span><br><span class="line">  v-&gt;f = f;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// increase the file&#x27;s reference count so that</span></span><br><span class="line">  <span class="comment">// the structure doesn&#x27;t disappear when the file is closed</span></span><br><span class="line">  filedup(v-&gt;f);</span><br><span class="line">  <span class="keyword">return</span> v-&gt;sva;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mmap系统调用返回了文件映射的起始虚拟地址，由于并没有实际创建映射，因此用户程序访问对应虚拟地址时会出现page fault，类似于copy-on-write，我们需要在出现usertrap函数中捕获page fault并从磁盘上读取文件内容创建映射，实现流程如下：</p>
<p>r_scause函数的返回值13和15对应读和写导致的page fault，并调用r_stval函数获取触发page fault的虚拟地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(r_scause() == <span class="number">13</span> || r_scause() == <span class="number">15</span>) &#123;</span><br><span class="line">  uint64 va = r_stval();</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">v</span> =</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((v = findvma(va)) == <span class="number">0</span>)&#123;</span><br><span class="line">   	<span class="built_in">printf</span>(<span class="string">&quot;usertrap(): no vma found for the given va %p\n&quot;</span>, r_stval());</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(filemap(v, va) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">   	<span class="built_in">printf</span>(<span class="string">&quot;usertrap(): fail to map file into user address region\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用findvma函数判断触发page fault的虚拟地址是否在进程的文件映射虚拟地址区域内，如果在则返回对应的vma结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct vma *</span></span><br><span class="line"><span class="function"><span class="title">findvma</span><span class="params">(uint64 va)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">v</span> =</span> <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(va &gt;= TRAPFRAME)</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;VMASIZE; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;vmas[i].valid)&#123;</span><br><span class="line">      <span class="keyword">if</span>(va &gt;= p-&gt;vmas[i].sva &amp;&amp; va &lt; p-&gt;vmas[i].sva + p-&gt;vmas[i].len)&#123;</span><br><span class="line">        v = &amp;p-&gt;vmas[i];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用filemap函数将文件映射到内存空间，大致流程如下：</p>
<ol>
<li>调用kalloc函数分配物理页面，调用memset函数用0填充页面（kalloc中默认用5填充，mmaptest中要求为0）</li>
<li>调用readi函数从文件指定位置读取PGSIZE字节数据写入内存</li>
<li>调用mappages函数映射虚拟地址到物理页面，根据对应vma结构体prot字段的值设置读写权限</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">filemap</span><span class="params">(struct vma *v, uint64 va)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  <span class="comment">// allocate a page of physical memory</span></span><br><span class="line">  <span class="keyword">void</span> *pa = kalloc();</span><br><span class="line">  <span class="keyword">if</span>(pa == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">// kalloc fill allocated page with 5, but mmaptest want 0</span></span><br><span class="line">  <span class="built_in">memset</span>(pa, <span class="number">0</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// read 4096 bytes of the relevant file into that page</span></span><br><span class="line">  begin_op();</span><br><span class="line">  ilock(v-&gt;f-&gt;ip);</span><br><span class="line">  readi(v-&gt;f-&gt;ip, <span class="number">0</span>, (uint64)pa, PGROUNDDOWN(va-v-&gt;sva) + v-&gt;offset, PGSIZE);</span><br><span class="line">  iunlock(v-&gt;f-&gt;ip);</span><br><span class="line">  end_op();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// map the page into user address space</span></span><br><span class="line">  <span class="keyword">int</span> flags = PTE_U;</span><br><span class="line">  <span class="keyword">if</span>(v-&gt;prot &amp; PROT_READ)</span><br><span class="line">    flags |= PTE_R;</span><br><span class="line">  <span class="keyword">if</span>(v-&gt;prot &amp; PROT_WRITE)</span><br><span class="line">    flags |= PTE_W;</span><br><span class="line">  <span class="keyword">if</span>(v-&gt;prot &amp; PROT_EXEC)</span><br><span class="line">    flags |= PTE_X;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(mappages(p-&gt;pagetable, va, PGSIZE, (uint64)pa, flags) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    kfree(pa);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>munmap系统调用实现流程如下：</p>
<ol>
<li>获取用户程序传入的unmap起始地址va和unmap长度len，va应小于TRAPFRAME</li>
<li>遍历进程vma数组，找到va对应的vma结构体（即va在对应vma的虚拟地址区域内），这里只有两种可能情况：传入的起始地址va等于vma的起始地址sva，unmap长度小于等于已映射长度；或va大于sva，且unmap的范围是va-end（end是已映射的最大虚拟地址）</li>
<li>调用uvmaunmap函数解除页表映射并释放物理页面（确保传入的va是PGSIZE的整数倍）</li>
<li>更新vma结构体，如果unmap了当前文件的所有映射，则调用fileclose函数减少文件引用数，重置vma结构体</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_munmap</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> len;</span><br><span class="line">  uint64 va;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(argaddr(<span class="number">0</span>, &amp;va) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span>(va &gt;= TRAPFRAME)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">1</span>, &amp;len) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// find the VMA for the address range</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">v</span> =</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;VMASIZE; i++)&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">vv</span> =</span> &amp;p-&gt;vmas[i];</span><br><span class="line">    uint64 end = vv-&gt;sva + vv-&gt;len;</span><br><span class="line">    <span class="keyword">if</span>(vv-&gt;valid)&#123;</span><br><span class="line">      <span class="comment">// An munmap call might cover only a portion of an mmap-ed region</span></span><br><span class="line">      <span class="comment">// but you can assume that it will either unmap at the start, or at the end</span></span><br><span class="line">      <span class="comment">// or the whole region (but not punch a hole in the middle of a region).</span></span><br><span class="line">      <span class="comment">// unmap at the start (inclue unmap the whole region)</span></span><br><span class="line">      <span class="keyword">if</span>(va == vv-&gt;sva &amp;&amp; va + len &lt;= end)&#123;</span><br><span class="line">        v = vv;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// unmap at the end</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(va &gt; vv-&gt;sva &amp;&amp; va + len == end)&#123;</span><br><span class="line">        v = vv;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(v == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// unmap the specified pages</span></span><br><span class="line">  <span class="keyword">if</span>(va &gt; v-&gt;sva)</span><br><span class="line">    va = PGROUNDUP(va);</span><br><span class="line"></span><br><span class="line">  uvmaunmap(p-&gt;pagetable, va, len/PGSIZE, v, <span class="number">1</span>);</span><br><span class="line">  <span class="comment">// update VMA</span></span><br><span class="line">  <span class="comment">// unmap at the start, update sva</span></span><br><span class="line">  <span class="keyword">if</span>(va == v-&gt;sva)&#123;</span><br><span class="line">    v-&gt;sva = va + len;</span><br><span class="line">  &#125;</span><br><span class="line">  v-&gt;len -= len;</span><br><span class="line">  <span class="comment">// unmap the whole region</span></span><br><span class="line">  <span class="comment">// decrement file ref count, free vma</span></span><br><span class="line">  <span class="keyword">if</span>(v-&gt;len == <span class="number">0</span>)&#123;</span><br><span class="line">    fileclose(v-&gt;f);</span><br><span class="line">    <span class="built_in">memset</span>(v, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct vma));</span><br><span class="line">    <span class="comment">// v-&gt;valid = 0;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>取消映射并释放物理页面时并没有使用uvmunmap函数，而是在其基础上进行了一些修改</p>
<ol>
<li>如果vma结构体设置了MAP_SHARED位，则将对应文件数据写回磁盘</li>
<li>移除对页表项PTE_V位的检查，因为lazy allocation可能导致虚拟地址并没有全部映射到物理页面上</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">uvmaunmap</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 va, uint64 npages, struct vma *v, <span class="keyword">int</span> do_free)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint64 a;</span><br><span class="line">  <span class="keyword">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((va % PGSIZE) != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;uvmaunmap: not aligned&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(v-&gt;flags &amp; MAP_SHARED)&#123;</span><br><span class="line">    filewrite(v-&gt;f, va, npages*PGSIZE);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span>(a = va; a &lt; va + npages*PGSIZE; a += PGSIZE)&#123;</span><br><span class="line">    <span class="keyword">if</span>((pte = walk(pagetable, a, <span class="number">0</span>)) == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmunmap: walk&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(PTE_FLAGS(*pte) == PTE_V)</span><br><span class="line">      panic(<span class="string">&quot;uvmunmap: not a leaf&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>((*pte &amp; PTE_V &amp;&amp; do_free))&#123;</span><br><span class="line">      uint64 pa = PTE2PA(*pte);</span><br><span class="line">      kfree((<span class="keyword">void</span>*)pa);</span><br><span class="line">    &#125;</span><br><span class="line">    *pte = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在exit函数中添加代码，移除当前进程所有还没有被移除的映射以及对应的物理页面</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">exit</span><span class="params">(<span class="keyword">int</span> status)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(p == initproc)</span><br><span class="line">    panic(<span class="string">&quot;init exiting&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;VMASIZE; i++)&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">v</span> =</span> &amp;p-&gt;vmas[i];</span><br><span class="line">    <span class="keyword">if</span>(v-&gt;valid)</span><br><span class="line">      uvmaunmap(p-&gt;pagetable, v-&gt;sva, v-&gt;len/PGSIZE, v, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">memset</span>(v, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct vma));</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在fork函数中添加代码，确保子进程和父进程具有相同的文件映射区域，复制到子进程时增加对应文件的引用数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">fork</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i, pid;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">np</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate process.</span></span><br><span class="line">  <span class="keyword">if</span>((np = allocproc()) == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// copy vmas to ensure child has the same mapped regions as parent</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;VMASIZE; i++)&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">v</span> =</span> &amp;p-&gt;vmas[i];</span><br><span class="line">    <span class="comment">// only copy valid vms and increment the reference count</span></span><br><span class="line">    <span class="keyword">if</span>(v-&gt;valid)&#123;</span><br><span class="line">      np-&gt;vmas[i] = *v;</span><br><span class="line">      filedup(v-&gt;f);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成lab10</p>
<p><img src="/2022/09/09/mit6.s081-lab10/result.png" alt="result">       </p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    
    <a class="pull-right" href="/2022/09/09/mit6.s081-lab3/">
        mit6.s081 lab3 - pgtbl →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By DaiWei Jia. All Rights Reserved.
                </p>
                <p>Theme By <a target="_blank" rel="noopener" href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
